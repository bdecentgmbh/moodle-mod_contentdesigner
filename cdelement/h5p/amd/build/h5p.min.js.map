{"version":3,"file":"h5p.min.js","sources":["../src/h5p.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Initializes and manages H5P elements within a Moodle environment.\n *\n * This module defines functions to handle user interactions with H5P content,\n * capturing xAPI events, and storing user responses. It listens for specific\n * xAPI verbs such as 'answered', 'completed', and 'interacted' to determine\n * when to store user responses. The module also handles the removal of warning\n * messages and refreshes content elements upon successful data storage.\n *\n * @module cdelement_h5p/h5p\n * @copyright  2024 bdecent gmbh <https://bdecent.de>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'mod_contentdesigner/elements', 'core/ajax', 'core/notification'], function ($, Elements, AJAX, Notification) {\n\n    var interactedInstances = [];\n\n    /**\n     * H5P element. Get the user reponse after attempt and send a request to store data in moodle.\n     *\n     * @param {int} instance\n     */\n    const elementH5P = (instance) => {\n        let instanceElem = document.querySelector('.h5p-element-instance[data-instanceid=\"' + instance + '\"]');\n        var iframe = instanceElem.querySelector('.h5p-iframe');\n        iframe.onload = () => h5pExternal(instance);\n    };\n\n    const h5pExternal = (instance) => {\n\n        let instanceElem = document.querySelector('.h5p-element-instance[data-instanceid=\"' + instance + '\"]');\n        var iframe = instanceElem.querySelector('.h5p-iframe');\n\n        if (iframe.contentWindow.H5P == undefined) {\n            setTimeout(() => elementH5P(instance), 200);\n            return;\n        }\n\n        var h5p = iframe.contentWindow.H5P;\n\n        if (h5p.externalDispatcher === undefined) {\n            setTimeout(() => elementH5P(instance), 200);\n            return;\n        }\n\n\n        h5p.externalDispatcher.on('xAPI', function (event) {\n\n            // Skip malformed events.\n            var hasStatement = event && event.data && event.data.statement;\n            if (!hasStatement) {\n                return;\n            }\n\n            var statement = event.data.statement;\n            var validVerb = statement.verb && statement.verb.id;\n            if (!validVerb) {\n                return;\n            }\n\n            var isCompleted = statement.verb.id === 'http://adlnet.gov/expapi/verbs/answered'\n                || statement.verb.id === 'http://adlnet.gov/expapi/verbs/completed';\n\n            var isChild = statement.context && statement.context.contextActivities &&\n                statement.context.contextActivities.parent &&\n                statement.context.contextActivities.parent[0] &&\n                statement.context.contextActivities.parent[0].id;\n            // Attempted response only stored.\n            var isInteract = statement.verb.id === 'http://adlnet.gov/expapi/verbs/interacted';\n            var isInteracted = false;\n            var isResponsed = false;\n            var extensionID;\n            if (isInteract) {\n                try {\n                    extensionID = statement.object.definition.extensions['http://h5p.org/x-api/h5p-local-content-id'];\n                    interactedInstances[extensionID] = true;\n                } catch (err) {\n                    Notification.alert(err);\n                }\n                return;\n            } else {\n                try {\n                    extensionID = statement.object.definition.extensions['http://h5p.org/x-api/h5p-local-content-id'];\n                    isInteracted = interactedInstances[extensionID] ?? false;\n                } catch (err) {\n                    Notification.alert(err);\n                }\n            }\n\n            if (statement.result === undefined) {\n                return;\n            }\n            // Remove the separator[,] from response.\n            if (statement.result.response !== undefined) {\n                var max = statement.result.score.max ?? 0;\n                var response = statement.result.response;\n                for (var i = 1; i <= max; i++) {\n                    response = response.replace('[,]', '');\n                }\n                isResponsed = (response != '');\n            } else {\n                // Response is not available.\n                isResponsed = true;\n            }\n\n            // If h5p has grade setup then student should pass all.\n            var isPassed = (statement.result.score.max < 1\n                || (statement.result.score.max == statement.result.score.raw)\n                || (statement.result.success !== undefined && statement.result.success == true));\n\n            if (isCompleted && !isChild && isResponsed && isInteracted && isPassed) {\n                var promises = storeUserResponse(statement, instance);\n                if (!promises) {\n                    return;\n                }\n                promises[0].then((response) => {\n                    if (response) {\n                        // Remove the warning message.\n                        removeWarning();\n                        // Update the other elemnets and chapters.\n                        Elements.refreshContent();\n                    }\n                    return;\n                }).catch(Notification.exception);\n            }\n        });\n    };\n\n    /**\n     * Remove the warning from response.\n     */\n    const removeWarning = () => {\n        if (Elements.courseContent().querySelector('.label.label-warning') !== null) {\n            Elements.courseContent().querySelector('.label.label-warning').remove();\n        }\n    };\n\n    /**\n     * Send the request to store the user h5p response.\n     * @param {Object} statement\n     * @param {int} instance\n     * @returns {Object}\n     */\n    const storeUserResponse = (statement, instance) => {\n\n        var params = {\n            cmid: Elements.contentDesignerData().cmid,\n            instanceid: instance,\n            result: {\n                completion: statement.result.completion ?? 0,\n                success: statement.result.success ?? 0,\n                duration: statement.result.duration ?? '',\n                response: statement.result.response ?? '',\n                score: {\n                    min: statement.result.score.min ?? 0,\n                    max: statement.result.score.max ?? 0,\n                    raw: statement.result.score.raw ?? 0,\n                    scaled: statement.result.score.scaled ?? 0\n                }\n            },\n        };\n\n        var promises = AJAX.call([{\n            methodname: 'cdelement_h5p_store_result',\n            args: params\n        }]);\n\n        return promises;\n    };\n\n    return {\n        init: function (instance) {\n            elementH5P(instance);\n        }\n    };\n});\n"],"names":["define","$","Elements","AJAX","Notification","interactedInstances","elementH5P","instance","document","querySelector","onload","h5pExternal","iframe","undefined","contentWindow","H5P","h5p","externalDispatcher","on","event","data","statement","verb","id","extensionID","isCompleted","isChild","context","contextActivities","parent","isInteracted","isResponsed","object","definition","extensions","err","alert","result","response","max","score","i","replace","isPassed","raw","success","promises","storeUserResponse","then","removeWarning","refreshContent","catch","exception","setTimeout","courseContent","remove","params","cmid","contentDesignerData","instanceid","completion","duration","min","scaled","call","methodname","args","init"],"mappings":"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"}