{"version":3,"file":"h5p.min.js","sources":["../src/h5p.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Initializes and manages H5P elements within a Moodle environment.\r\n *\r\n * This module defines functions to handle user interactions with H5P content,\r\n * capturing xAPI events, and storing user responses. It listens for specific\r\n * xAPI verbs such as 'answered', 'completed', and 'interacted' to determine\r\n * when to store user responses. The module also handles the removal of warning\r\n * messages and refreshes content elements upon successful data storage.\r\n *\r\n * @module cdelement_h5p/h5p\r\n * @copyright  2024 bdecent gmbh <https://bdecent.de>\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'mod_contentdesigner/elements', 'core/ajax', 'core/notification'], function ($, Elements, AJAX, Notification) {\r\n\r\n    var interactedInstances = [];\r\n\r\n    /**\r\n     * H5P element. Get the user reponse after attempt and send a request to store data in moodle.\r\n     *\r\n     * @param {int} instance\r\n     */\r\n    const elementH5P = (instance) => {\r\n        let instanceElem = document.querySelector('.h5p-element-instance[data-instanceid=\"' + instance + '\"]');\r\n        var iframe = instanceElem.querySelector('.h5p-iframe');\r\n        iframe.onload = () => h5pExternal(instance);\r\n    };\r\n\r\n    const h5pExternal = (instance) => {\r\n\r\n        let instanceElem = document.querySelector('.h5p-element-instance[data-instanceid=\"' + instance + '\"]');\r\n        var iframe = instanceElem.querySelector('.h5p-iframe');\r\n\r\n        if (iframe.contentWindow.H5P == undefined) {\r\n            setTimeout(() => elementH5P(instance), 200);\r\n            return;\r\n        }\r\n\r\n        var h5p = iframe.contentWindow.H5P;\r\n\r\n        if (h5p.externalDispatcher === undefined) {\r\n            setTimeout(() => elementH5P(instance), 200);\r\n            return;\r\n        }\r\n\r\n\r\n        h5p.externalDispatcher.on('xAPI', function (event) {\r\n\r\n            // Skip malformed events.\r\n            var hasStatement = event && event.data && event.data.statement;\r\n            if (!hasStatement) {\r\n                return;\r\n            }\r\n\r\n            var statement = event.data.statement;\r\n            var validVerb = statement.verb && statement.verb.id;\r\n            if (!validVerb) {\r\n                return;\r\n            }\r\n\r\n            var isCompleted = statement.verb.id === 'http://adlnet.gov/expapi/verbs/answered'\r\n                || statement.verb.id === 'http://adlnet.gov/expapi/verbs/completed';\r\n\r\n            var isChild = statement.context && statement.context.contextActivities &&\r\n                statement.context.contextActivities.parent &&\r\n                statement.context.contextActivities.parent[0] &&\r\n                statement.context.contextActivities.parent[0].id;\r\n            // Attempted response only stored.\r\n            var isInteract = statement.verb.id === 'http://adlnet.gov/expapi/verbs/interacted';\r\n            var isInteracted = false;\r\n            var isResponsed = false;\r\n            var extensionID;\r\n            if (isInteract) {\r\n                try {\r\n                    extensionID = statement.object.definition.extensions['http://h5p.org/x-api/h5p-local-content-id'];\r\n                    interactedInstances[extensionID] = true;\r\n                } catch (err) {\r\n                    Notification.alert(err);\r\n                }\r\n                return;\r\n            } else {\r\n                try {\r\n                    extensionID = statement.object.definition.extensions['http://h5p.org/x-api/h5p-local-content-id'];\r\n                    isInteracted = interactedInstances[extensionID] ?? false;\r\n                } catch (err) {\r\n                    Notification.alert(err);\r\n                }\r\n            }\r\n\r\n            if (statement.result === undefined) {\r\n                return;\r\n            }\r\n            // Remove the separator[,] from response.\r\n            if (statement.result.response !== undefined) {\r\n                var max = statement.result.score.max ?? 0;\r\n                var response = statement.result.response;\r\n                for (var i = 1; i <= max; i++) {\r\n                    response = response.replace('[,]', '');\r\n                }\r\n                isResponsed = (response != '');\r\n            } else {\r\n                // Response is not available.\r\n                isResponsed = true;\r\n            }\r\n\r\n            // If h5p has grade setup then student should pass all.\r\n            var isPassed = (statement.result.score.max < 1\r\n                || (statement.result.score.max == statement.result.score.raw)\r\n                || (statement.result.success !== undefined && statement.result.success == true));\r\n\r\n            if (isCompleted && !isChild && isResponsed && isInteracted && isPassed) {\r\n                var promises = storeUserResponse(statement, instance);\r\n                if (!promises) {\r\n                    return;\r\n                }\r\n                promises[0].then((response) => {\r\n                    if (response) {\r\n                        // Remove the warning message.\r\n                        removeWarning();\r\n                        // Update the other elemnets and chapters.\r\n                        Elements.refreshContent();\r\n                    }\r\n                    return;\r\n                }).catch(Notification.exception);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Remove the warning from response.\r\n     */\r\n    const removeWarning = () => {\r\n        if (Elements.courseContent().querySelector('.label.label-warning') !== null) {\r\n            Elements.courseContent().querySelector('.label.label-warning').remove();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Send the request to store the user h5p response.\r\n     * @param {Object} statement\r\n     * @param {int} instance\r\n     * @returns {Object}\r\n     */\r\n    const storeUserResponse = (statement, instance) => {\r\n\r\n        var params = {\r\n            cmid: Elements.contentDesignerData().cmid,\r\n            instanceid: instance,\r\n            result: {\r\n                completion: statement.result.completion ?? 0,\r\n                success: statement.result.success ?? 0,\r\n                duration: statement.result.duration ?? '',\r\n                response: statement.result.response ?? '',\r\n                score: {\r\n                    min: statement.result.score.min ?? 0,\r\n                    max: statement.result.score.max ?? 0,\r\n                    raw: statement.result.score.raw ?? 0,\r\n                    scaled: statement.result.score.scaled ?? 0\r\n                }\r\n            },\r\n        };\r\n\r\n        var promises = AJAX.call([{\r\n            methodname: 'cdelement_h5p_store_result',\r\n            args: params\r\n        }]);\r\n\r\n        return promises;\r\n    };\r\n\r\n    return {\r\n        init: function (instance) {\r\n            elementH5P(instance);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Elements","AJAX","Notification","interactedInstances","elementH5P","instance","document","querySelector","onload","h5pExternal","iframe","undefined","contentWindow","H5P","h5p","externalDispatcher","on","event","data","statement","verb","id","extensionID","isCompleted","isChild","context","contextActivities","parent","isInteracted","isResponsed","object","definition","extensions","err","alert","result","response","max","score","i","replace","isPassed","raw","success","promises","storeUserResponse","then","removeWarning","refreshContent","catch","exception","setTimeout","courseContent","remove","params","cmid","contentDesignerData","instanceid","completion","duration","min","scaled","call","methodname","args","init"],"mappings":"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"}