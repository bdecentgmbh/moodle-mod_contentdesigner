{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Provides actions for the content designer editor, including update, edit, and move element functionalities.\r\n *\r\n * @module mod_contentdesigner/editor\r\n * @copyright  2024 bdecent gmbh <https://bdecent.de>\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/str',\r\n    'core/fragment', 'core/templates', 'core/notification', 'core/loadingicon', 'core/modal'],\r\n    function ($, ModalFactory, ModalEvents, Str, Fragment, Templates, Notification, LoadingIcon, Modal) {\r\n\r\n        var contextID;\r\n\r\n        var cmID;\r\n\r\n        let loaderItem = '.contentdesigner-content';\r\n\r\n        const editor = (contextid, cmid) => {\r\n            if (document.body.id !== 'page-mod-contentdesigner-editor') {\r\n                return null;\r\n            }\r\n            contextID = contextid;\r\n            cmID = cmid;\r\n            initEventListeners();\r\n            return null;\r\n        };\r\n\r\n        const initEventListeners = () => {\r\n            document.body.addEventListener('click', (e) => {\r\n                var addElement = e.target.closest('.contentdesigner-addelement');\r\n                var elementAction = e.target.closest(\".element-item .element-actions .action-item\");\r\n                var moduleElement = e.target.closest(\"div.element-item\");\r\n                if (elementAction && elementAction != undefined\r\n                    && moduleElement && moduleElement != undefined) {\r\n                    var action = elementAction.getAttribute('data-action');\r\n                    var elementId = moduleElement.getAttribute('data-elementid');\r\n                    var element = moduleElement.getAttribute('data-elementshortname');\r\n                    var instanceId = moduleElement.getAttribute('data-instanceid');\r\n                    if (action === 'delete') {\r\n                        // Deleting requires confirmation.\r\n                        confirmDeleteElement(element, function () {\r\n                            editElement(moduleElement, elementId, instanceId, action);\r\n                        });\r\n                    }\r\n\r\n                    if (action == 'moveup' || action == 'movedown') {\r\n                        moveElement(moduleElement, action);\r\n                    }\r\n\r\n                    if (action == 'status') {\r\n                        updateStatus(moduleElement);\r\n                    }\r\n                }\r\n\r\n                if (addElement && addElement != undefined) {\r\n                    e.preventDefault();\r\n                    var position = addElement.dataset.position;\r\n                    var chapter = addElement.dataset.chapter;\r\n                    buildAddElementModal(position, chapter);\r\n                }\r\n\r\n            });\r\n        };\r\n\r\n\r\n        const moveElement = (moduleElement, action) => {\r\n            var promise;\r\n            if (moduleElement.dataset.elementshortname == 'chapter') {\r\n                var item = moduleElement.closest('.chapters-list');\r\n                if (action == 'moveup') {\r\n                    item.parentNode.insertBefore(item, item.previousElementSibling);\r\n                } else {\r\n                    item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\r\n                }\r\n                let contents = [];\r\n                var items = document.querySelectorAll('ul.course-content-list .chapters-content');\r\n                items.forEach((item) => {\r\n                    contents.push(item.dataset.id);\r\n                });\r\n                let params = {\r\n                    chapters: contents.join(','),\r\n                    cmid: cmID\r\n                };\r\n                promise = Fragment.loadFragment('mod_contentdesigner', 'move_chapter', contextID, params).done((html, js) => {\r\n                    Templates.replaceNode('.contentdesigner-content', html, js);\r\n                }).fail(Notification.exception);\r\n                LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n            } else {\r\n\r\n                let chapter = moduleElement.closest('.chapters-content');\r\n                let item = moduleElement.parentNode;\r\n                if (action == 'moveup') {\r\n                    // Append to the Previous chapter if this item is first in the list.\r\n                    if (item.previousElementSibling === null) {\r\n                        let previousChapter = item.closest('.chapters-list').previousElementSibling;\r\n                        // To fix the moodle CI nested loop count of 5. Tested separetly.\r\n                        var append = false;\r\n                        if (previousChapter !== null) {\r\n                            previousChapter.querySelector('.chapter-elements-list').append(item);\r\n                            append = true;\r\n                        }\r\n                        if (append && previousChapter.childNodes[1] != undefined) {\r\n                            updateChapterElements(previousChapter.childNodes[1]);\r\n                        }\r\n                    } else {\r\n                        item.parentNode.insertBefore(item, item.previousElementSibling);\r\n                    }\r\n                } else {\r\n                    // Prepend to the next chapter if this item is last in the list.\r\n                    if (item.nextElementSibling === null) {\r\n                        let nextChapter = item.closest('.chapters-list').nextElementSibling;\r\n                        // To fix the moodle CI nested loop count of 5. Tested separetly.\r\n                        var prepend = false;\r\n                        if (nextChapter !== null) {\r\n                            nextChapter.querySelector('.chapter-elements-list').prepend(item);\r\n                            prepend = true;\r\n                        }\r\n                        if (prepend && nextChapter.childNodes[1] != undefined) {\r\n                            updateChapterElements(nextChapter.childNodes[1]);\r\n                        }\r\n\r\n                    } else {\r\n                        item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\r\n                    }\r\n                }\r\n\r\n                promise = updateChapterElements(chapter);\r\n                LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n            }\r\n        };\r\n\r\n        const updateChapterElements = (chapter) => {\r\n            let contents = [];\r\n            var items = chapter.querySelectorAll('li.element-item > div.element-item');\r\n            items.forEach((item) => {\r\n                contents.push(item.dataset.contentid);\r\n            });\r\n            let params = {\r\n                contents: contents.join(','),\r\n                chapterid: chapter.dataset.id,\r\n                cmid: cmID\r\n            };\r\n            var promise = Fragment.loadFragment('mod_contentdesigner', 'move_element', contextID, params);\r\n            promise.done((html, js) => {\r\n                Templates.replaceNode('.contentdesigner-content', html, js);\r\n            });\r\n\r\n            return promise;\r\n        };\r\n\r\n        var updateStatus = (moduleElement) => {\r\n            let statusElement = moduleElement.querySelector('[data-action=\"status\"] > i');\r\n            var params = {\r\n                element: moduleElement.dataset.elementshortname,\r\n                instance: moduleElement.dataset.instanceid,\r\n                status: moduleElement.dataset.visibility == true ? false : true,\r\n                cmid: cmID\r\n            };\r\n\r\n            if (moduleElement.dataset.visibility == true) {\r\n                statusElement.classList.remove('fa-eye');\r\n                statusElement.classList.add('fa-eye-slash');\r\n                moduleElement.dataset.visibility = false;\r\n            } else {\r\n                statusElement.classList.remove('fa-eye-slash');\r\n                statusElement.classList.add('fa-eye');\r\n                moduleElement.dataset.visibility = true;\r\n            }\r\n\r\n            var promise = Fragment.loadFragment('mod_contentdesigner', 'update_visibility', contextID, params).then(() => {\r\n                return true;\r\n            });\r\n            LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n        };\r\n\r\n\r\n        /**\r\n         * Performs an action on a element (moving, deleting, duplicating, hiding, etc.)\r\n         *\r\n         * @param {JQuery} moduleElement activity element we perform action on\r\n         * @param {Number} elementId\r\n         * @param {Number} instanceId\r\n         * @param {String} action Action of the current clicked element.\r\n         */\r\n        var editElement = function (moduleElement, elementId, instanceId, action) {\r\n            var args = {\r\n                cmid: cmID,\r\n                action: action,\r\n                elementid: elementId,\r\n                instanceid: instanceId,\r\n            };\r\n            Fragment.loadFragment('mod_contentdesigner', 'edit_element', contextID, args).then((html) => {\r\n                moduleElement.parentNode.replaceWith(html);\r\n                return;\r\n            }).fail(Notification.exception);\r\n        };\r\n\r\n        /**\r\n         * Displays the delete confirmation to delete a module\r\n         *\r\n         * @param {String} element\r\n         * @param {Function} onconfirm function to execute on confirm\r\n         */\r\n        var confirmDeleteElement = function (element, onconfirm) {\r\n            var elementTypename = 'cdelement_'.element;\r\n            Str.get_string('pluginname', elementTypename).done(function () {\r\n                var plugindata = {\r\n                    element: element\r\n                };\r\n                Str.get_strings([\r\n                    { key: 'confirm', component: 'core' },\r\n                    { key: 'deletechecktype', component: 'mod_contentdesigner', param: plugindata },\r\n                    { key: 'yes' },\r\n                    { key: 'no' }\r\n                ]).done(function (s) {\r\n                    Notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\r\n                }\r\n                );\r\n            });\r\n        };\r\n\r\n        /**\r\n         * Load the elements list modal to insert new element\r\n         *\r\n         * @param {String} position where the element need to insert.\r\n         * @param {Boolean} chapter chapter id to insert element.\r\n         * @returns {Object}\r\n         */\r\n        const buildAddElementModal = (position = \"bottom\", chapter = 0) => {\r\n            var params = { cmid: cmID };\r\n\r\n            if ((typeof Modal.registerModalType !== 'undefined')) {\r\n                var promise = Modal.create({\r\n                    type: ModalFactory.TYPE,\r\n                    title: Str.get_string('addelement', 'contentdesigner'),\r\n                    body: Fragment.loadFragment('mod_contentdesigner', 'get_elements_list', contextID, params),\r\n                    large: false,\r\n                });\r\n            } else {\r\n                var promise = ModalFactory.create({\r\n                    type: ModalFactory.TYPE,\r\n                    title: Str.get_string('addelement', 'contentdesigner'),\r\n                    body: Fragment.loadFragment('mod_contentdesigner', 'get_elements_list', contextID, params),\r\n                    large: false,\r\n                });\r\n            }\r\n\r\n            promise.then(modal => {\r\n                modal.getRoot().on(ModalEvents.bodyRendered, function () {\r\n                    modal.getRoot().get(0).querySelectorAll('.element-item').forEach((e) => {\r\n                        e.addEventListener('click', function (e) {\r\n                            if (e.target.closest('.element-item')) {\r\n                                var element = e.currentTarget.dataset.element;\r\n                                var params = {\r\n                                    cmid: cmID,\r\n                                    element: element,\r\n                                    chapter: chapter,\r\n                                    position: position,\r\n                                    sesskey: M.cfg.sesskey\r\n                                };\r\n                                const urlParams = new URLSearchParams(params);\r\n                                window.location = M.cfg.wwwroot + '/mod/contentdesigner/element.php?' + urlParams.toString();\r\n                            }\r\n                        });\r\n                    });\r\n                });\r\n                modal.show();\r\n                return modal;\r\n            });\r\n        };\r\n\r\n        return {\r\n            init: function (contextid, cmid) {\r\n                return editor(contextid, cmid);\r\n            }\r\n        };\r\n    });\r\n"],"names":["define","$","ModalFactory","ModalEvents","Str","Fragment","Templates","Notification","LoadingIcon","Modal","contextID","cmID","loaderItem","initEventListeners","document","body","addEventListener","e","addElement","target","closest","elementAction","moduleElement","undefined","action","getAttribute","elementId","element","instanceId","confirmDeleteElement","editElement","moveElement","updateStatus","preventDefault","position","dataset","chapter","buildAddElementModal","promise","elementshortname","item","parentNode","insertBefore","previousElementSibling","nextElementSibling","contents","querySelectorAll","forEach","push","id","params","chapters","join","cmid","loadFragment","done","html","js","replaceNode","fail","exception","addIconToContainerRemoveOnCompletion","previousChapter","append","querySelector","childNodes","updateChapterElements","nextChapter","prepend","contentid","chapterid","statusElement","instance","instanceid","status","visibility","classList","remove","add","then","args","elementid","replaceWith","onconfirm","elementTypename","get_string","plugindata","get_strings","key","component","param","s","confirm","registerModalType","create","type","TYPE","title","large","modal","getRoot","on","bodyRendered","get","currentTarget","sesskey","M","cfg","urlParams","URLSearchParams","window","location","wwwroot","toString","show","init","contextid","editor"],"mappings":"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"}