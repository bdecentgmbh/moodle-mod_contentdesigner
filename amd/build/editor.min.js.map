{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides actions for the content designer editor, including update, edit, and move element functionalities.\n *\n * @module mod_contentdesigner/editor\n * @copyright  2024 bdecent gmbh <https://bdecent.de>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/str',\n    'core/fragment', 'core/templates', 'core/notification', 'core/loadingicon', 'core/modal'],\n    function ($, ModalFactory, ModalEvents, Str, Fragment, Templates, Notification, LoadingIcon, Modal) {\n\n        /* global contentDesigner */\n        var Data = contentDesigner;\n\n        let contextID;\n\n        let cmID;\n\n        let loaderItem = '.contentdesigner-content';\n\n        const editor = (contextid, cmid) => {\n            if (document.body.id !== 'page-mod-contentdesigner-editor') {\n                return null;\n            }\n            contextID = contextid;\n            cmID = cmid;\n            initEventListeners();\n            return null;\n        };\n\n        const initEventListeners = () => {\n            document.body.addEventListener('click', (e) => {\n                var addElement = e.target.closest('.contentdesigner-addelement');\n                var elementAction = e.target.closest(\".element-item .element-actions .action-item\");\n                var moduleElement = e.target.closest(\"div.element-item\");\n                if (elementAction && elementAction != undefined\n                    && moduleElement && moduleElement != undefined) {\n                    var action = elementAction.getAttribute('data-action');\n                    var elementId = moduleElement.getAttribute('data-elementid');\n                    var element = moduleElement.getAttribute('data-elementshortname');\n                    var instanceId = moduleElement.getAttribute('data-instanceid');\n                    if (action === 'delete') {\n                        // Deleting requires confirmation.\n                        confirmDeleteElement(element, function () {\n                            editElement(moduleElement, elementId, instanceId, action);\n                        });\n                    }\n\n                    if (action == 'moveup' || action == 'movedown') {\n                        moveElement(moduleElement, action);\n                    }\n\n                    if (action == 'status') {\n                        updateStatus(moduleElement);\n                    }\n                }\n\n                if (addElement && addElement != undefined) {\n                    e.preventDefault();\n                    var position = addElement.dataset.position;\n                    var chapter = addElement.dataset.chapter;\n                    buildAddElementModal(position, chapter);\n                }\n\n            });\n        };\n\n\n        const moveElement = (moduleElement, action) => {\n            var promise;\n            if (moduleElement.dataset.elementshortname == 'chapter') {\n                var item = moduleElement.closest('.chapters-list');\n                if (action == 'moveup') {\n                    item.parentNode.insertBefore(item, item.previousElementSibling);\n                } else {\n                    item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\n                }\n                let contents = [];\n                var items = document.querySelectorAll('ul.course-content-list .chapters-content');\n                items.forEach((item) => {\n                    contents.push(item.dataset.id);\n                });\n                let params = {\n                    chapters: contents.join(','),\n                    cmid: Data.cm.id\n                };\n                promise = Fragment.loadFragment('mod_contentdesigner', 'move_chapter', Data.contextid, params).done((html, js) => {\n                    Templates.replaceNode('.contentdesigner-content', html, js);\n                }).fail(Notification.exception);\n                LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\n            } else {\n\n                let chapter = moduleElement.closest('.chapters-content');\n                let item = moduleElement.parentNode;\n                if (action == 'moveup') {\n                    // Append to the Previous chapter if this item is first in the list.\n                    if (item.previousElementSibling === null) {\n                        let previousChapter = item.closest('.chapters-list').previousElementSibling;\n                        // To fix the moodle CI nested loop count of 5. Tested separetly.\n                        var append = false;\n                        if (previousChapter !== null) {\n                            previousChapter.querySelector('.chapter-elements-list').append(item);\n                            append = true;\n                        }\n                        if (append && previousChapter.childNodes[1] != undefined) {\n                            updateChapterElements(previousChapter.childNodes[1]);\n                        }\n                    } else {\n                        item.parentNode.insertBefore(item, item.previousElementSibling);\n                    }\n                } else {\n                    // Prepend to the next chapter if this item is last in the list.\n                    if (item.nextElementSibling === null) {\n                        let nextChapter = item.closest('.chapters-list').nextElementSibling;\n                        // To fix the moodle CI nested loop count of 5. Tested separetly.\n                        var prepend = false;\n                        if (nextChapter !== null) {\n                            nextChapter.querySelector('.chapter-elements-list').prepend(item);\n                            prepend = true;\n                        }\n                        if (prepend && nextChapter.childNodes[1] != undefined) {\n                            updateChapterElements(nextChapter.childNodes[1]);\n                        }\n\n                    } else {\n                        item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\n                    }\n                }\n\n                promise = updateChapterElements(chapter);\n                LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\n            }\n        };\n\n        const updateChapterElements = (chapter) => {\n            let contents = [];\n            var items = chapter.querySelectorAll('li.element-item > div.element-item');\n            items.forEach((item) => {\n                contents.push(item.dataset.contentid);\n            });\n            let params = {\n                contents: contents.join(','),\n                chapterid: chapter.dataset.id,\n                cmid: Data.cm.id\n            };\n            var promise = Fragment.loadFragment('mod_contentdesigner', 'move_element', Data.contextid, params);\n            promise.done((html, js) => {\n                Templates.replaceNode('.contentdesigner-content', html, js);\n            });\n\n            return promise;\n        };\n\n        var updateStatus = (moduleElement) => {\n            let statusElement = moduleElement.querySelector('[data-action=\"status\"] > i');\n            var params = {\n                element: moduleElement.dataset.elementshortname,\n                instance: moduleElement.dataset.instanceid,\n                status: moduleElement.dataset.visibility == true ? false : true,\n                cmid: Data.cm.id\n            };\n\n            if (moduleElement.dataset.visibility == true) {\n                statusElement.classList.remove('fa-eye');\n                statusElement.classList.add('fa-eye-slash');\n                moduleElement.dataset.visibility = false;\n            } else {\n                statusElement.classList.remove('fa-eye-slash');\n                statusElement.classList.add('fa-eye');\n                moduleElement.dataset.visibility = true;\n            }\n\n            var promise = Fragment.loadFragment('mod_contentdesigner', 'update_visibility', Data.contextid, params).then(() => {\n                return true;\n            });\n            LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\n        };\n\n\n        /**\n         * Performs an action on a element (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} moduleElement activity element we perform action on\n         * @param {Number} elementId\n         * @param {Number} instanceId\n         * @param {String} action Action of the current clicked element.\n         */\n        var editElement = function (moduleElement, elementId, instanceId, action) {\n            var args = {\n                cmid: cmID,\n                action: action,\n                elementid: elementId,\n                instanceid: instanceId,\n            };\n            Fragment.loadFragment('mod_contentdesigner', 'edit_element', contextID, args).then((html) => {\n                moduleElement.parentNode.replaceWith(html);\n                return;\n            }).fail(Notification.exception);\n        };\n\n        /**\n         * Displays the delete confirmation to delete a module\n         *\n         * @param {String} element\n         * @param {Function} onconfirm function to execute on confirm\n         */\n        var confirmDeleteElement = function (element, onconfirm) {\n            var elementTypename = 'element_'.element;\n            Str.get_string('pluginname', elementTypename).done(function () {\n                var plugindata = {\n                    element: element\n                };\n                Str.get_strings([\n                    { key: 'confirm', component: 'core' },\n                    { key: 'deletechecktype', component: 'mod_contentdesigner', param: plugindata },\n                    { key: 'yes' },\n                    { key: 'no' }\n                ]).done(function (s) {\n                    Notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\n                }\n                );\n            });\n        };\n\n        /**\n         * Load the elements list modal to insert new element\n         *\n         * @param {String} position where the element need to insert.\n         * @param {Boolean} chapter chapter id to insert element.\n         * @returns {Object}\n         */\n        const buildAddElementModal = (position = \"bottom\", chapter = 0) => {\n            var params = { cmid: Data.cm.id };\n\n            if ((typeof Modal.registerModalType !== 'undefined')) {\n                var promise = Modal.create({\n                    type: ModalFactory.TYPE,\n                    title: Str.get_string('addelement', 'contentdesigner'),\n                    body: Fragment.loadFragment('mod_contentdesigner', 'get_elements_list', contextID, params),\n                    large: false,\n                });\n            } else {\n                var promise = ModalFactory.create({\n                    type: ModalFactory.TYPE,\n                    title: Str.get_string('addelement', 'contentdesigner'),\n                    body: Fragment.loadFragment('mod_contentdesigner', 'get_elements_list', contextID, params),\n                    large: false,\n                });\n            }\n\n            promise.then(modal => {\n                modal.getRoot().on(ModalEvents.bodyRendered, function () {\n                    modal.getRoot().get(0).querySelectorAll('.element-item').forEach((e) => {\n                        e.addEventListener('click', function (e) {\n                            if (e.target.closest('.element-item')) {\n                                var element = e.currentTarget.dataset.element;\n                                var params = {\n                                    cmid: Data.cm.id,\n                                    element: element,\n                                    chapter: chapter,\n                                    position: position,\n                                    sesskey: M.cfg.sesskey\n                                };\n                                const urlParams = new URLSearchParams(params);\n                                window.location = M.cfg.wwwroot + '/mod/contentdesigner/element.php?' + urlParams.toString();\n                            }\n                        });\n                    });\n                });\n                modal.show();\n                return modal;\n            });\n        };\n\n        return {\n            init: function (contextid, cmid) {\n                return editor(contextid, cmid);\n            }\n        };\n    });\n"],"names":["define","$","ModalFactory","ModalEvents","Str","Fragment","Templates","Notification","LoadingIcon","Modal","Data","contentDesigner","contextID","cmID","loaderItem","initEventListeners","document","body","addEventListener","e","addElement","target","closest","elementAction","moduleElement","undefined","action","getAttribute","elementId","element","instanceId","confirmDeleteElement","editElement","moveElement","updateStatus","preventDefault","position","dataset","chapter","buildAddElementModal","promise","elementshortname","item","parentNode","insertBefore","previousElementSibling","nextElementSibling","contents","querySelectorAll","forEach","push","id","params","chapters","join","cmid","cm","loadFragment","contextid","done","html","js","replaceNode","fail","exception","addIconToContainerRemoveOnCompletion","previousChapter","append","querySelector","childNodes","updateChapterElements","nextChapter","prepend","contentid","chapterid","statusElement","instance","instanceid","status","visibility","classList","remove","add","then","args","elementid","replaceWith","onconfirm","elementTypename","get_string","plugindata","get_strings","key","component","param","s","confirm","registerModalType","create","type","TYPE","title","large","modal","getRoot","on","bodyRendered","get","currentTarget","sesskey","M","cfg","urlParams","URLSearchParams","window","location","wwwroot","toString","show","init","editor"],"mappings":"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"}