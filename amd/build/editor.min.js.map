{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["define(['jquery', 'core/modal_factory', 'core/modal_events', 'core/str',\r\n    'core/fragment', 'core/templates', 'core/notification', 'core/loadingicon'],\r\n    function($, Modal, ModalEvents, Str, Fragment, Templates, Notification, LoadingIcon) {\r\n\r\n    /* global contentDesigner */\r\n    var Data = contentDesigner;\r\n\r\n    let contextID;\r\n\r\n    let cmID;\r\n\r\n    let loaderItem = '.contentdesigner-content';\r\n\r\n    const editor = (contextid, cmid) => {\r\n        if (document.body.id !== 'page-mod-contentdesigner-editor') {\r\n            return null;\r\n        }\r\n        contextID = contextid;\r\n        cmID = cmid;\r\n        initEventListeners();\r\n        return null;\r\n    };\r\n\r\n    const initEventListeners = () => {\r\n        document.body.addEventListener('click', (e) => {\r\n            var addElement = e.target.closest('.contentdesigner-addelement');\r\n            var elementAction = e.target.closest(\".element-item .element-actions .action-item\");\r\n            var moduleElement = e.target.closest(\"div.element-item\");\r\n            if (elementAction && elementAction != undefined\r\n                && moduleElement && moduleElement != undefined) {\r\n                var action = elementAction.getAttribute('data-action');\r\n                var elementId = moduleElement.getAttribute('data-elementid');\r\n                var element = moduleElement.getAttribute('data-elementshortname');\r\n                var instanceId = moduleElement.getAttribute('data-instanceid');\r\n                if (action === 'delete') {\r\n                    // Deleting requires confirmation.\r\n                    confirmDeleteElement(element, function() {\r\n                        editElement(moduleElement, elementId, instanceId, action);\r\n                    });\r\n                }\r\n\r\n                if (action == 'moveup' || action == 'movedown') {\r\n                    moveElement(moduleElement, action);\r\n                }\r\n\r\n                if (action == 'status') {\r\n                    updateStatus(moduleElement);\r\n                }\r\n            }\r\n\r\n            if (addElement && addElement != undefined) {\r\n                e.preventDefault();\r\n                var position = addElement.dataset.position;\r\n                var chapter = addElement.dataset.chapter;\r\n                buildAddElementModal(position, chapter);\r\n            }\r\n\r\n        });\r\n    };\r\n\r\n\r\n    const moveElement = (moduleElement, action) => {\r\n        var promise;\r\n        if (moduleElement.dataset.elementshortname == 'chapter') {\r\n            var item = moduleElement.closest('.chapters-list');\r\n            if (action == 'moveup') {\r\n                item.parentNode.insertBefore(item, item.previousElementSibling);\r\n            } else {\r\n                item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\r\n            }\r\n            let contents = [];\r\n            var items = document.querySelectorAll('ul.course-content-list .chapters-content');\r\n            items.forEach((item) => {\r\n                contents.push(item.dataset.id);\r\n            });\r\n            let params = {\r\n                chapters: contents.join(','),\r\n                cmid: Data.cm.id\r\n            };\r\n            promise = Fragment.loadFragment('mod_contentdesigner', 'move_chapter', Data.contextid, params).done((html, js) => {\r\n                Templates.replaceNode('.contentdesigner-content', html, js);\r\n            }).fail(Notification.exception);\r\n            LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n        } else {\r\n\r\n            let chapter = moduleElement.closest('.chapters-content');\r\n            let item = moduleElement.parentNode;\r\n            if (action == 'moveup') {\r\n                // Append to the Previous chapter if this item is first in the list.\r\n                if (item.previousElementSibling === null) {\r\n                    let previousChapter = item.closest('.chapters-list').previousElementSibling;\r\n                    // To fix the moodle CI nested loop count of 5. Tested separetly.\r\n                    var append = false;\r\n                    if (previousChapter !== null) {\r\n                        previousChapter.querySelector('.chapter-elements-list').append(item);\r\n                        append = true;\r\n                    }\r\n                    if (append && previousChapter.childNodes[1] != undefined) {\r\n                        updateChapterElements(previousChapter.childNodes[1]);\r\n                    }\r\n                } else {\r\n                    item.parentNode.insertBefore(item, item.previousElementSibling);\r\n                }\r\n            } else {\r\n                // Prepend to the next chapter if this item is last in the list.\r\n                if (item.nextElementSibling === null) {\r\n                    let nextChapter = item.closest('.chapters-list').nextElementSibling;\r\n                    // To fix the moodle CI nested loop count of 5. Tested separetly.\r\n                    var prepend = false;\r\n                    if (nextChapter !== null) {\r\n                        nextChapter.querySelector('.chapter-elements-list').prepend(item);\r\n                        prepend = true;\r\n                    }\r\n                    if (prepend && nextChapter.childNodes[1] != undefined) {\r\n                        updateChapterElements(nextChapter.childNodes[1]);\r\n                    }\r\n\r\n                } else {\r\n                    item.parentNode.insertBefore(item, item.nextElementSibling.nextElementSibling);\r\n                }\r\n            }\r\n\r\n            promise = updateChapterElements(chapter);\r\n            LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n        }\r\n    };\r\n\r\n    const updateChapterElements = (chapter) => {\r\n        let contents = [];\r\n        var items = chapter.querySelectorAll('li.element-item > div.element-item');\r\n        items.forEach((item) => {\r\n            contents.push(item.dataset.contentid);\r\n        });\r\n        let params = {\r\n            contents: contents.join(','),\r\n            chapterid: chapter.dataset.id,\r\n            cmid: Data.cm.id\r\n        };\r\n        var promise = Fragment.loadFragment('mod_contentdesigner', 'move_element', Data.contextid, params);\r\n        promise.done((html, js) => {\r\n            Templates.replaceNode('.contentdesigner-content', html, js);\r\n        });\r\n\r\n        return promise;\r\n    };\r\n\r\n    var updateStatus = (moduleElement) => {\r\n        let statusElement = moduleElement.querySelector('[data-action=\"status\"] > i');\r\n        var params = {\r\n            element: moduleElement.dataset.elementshortname,\r\n            instance: moduleElement.dataset.instanceid,\r\n            status: moduleElement.dataset.visibility == true ? false : true,\r\n            cmid: Data.cm.id\r\n        };\r\n\r\n        if (moduleElement.dataset.visibility == true) {\r\n            statusElement.classList.remove('fa-eye');\r\n            statusElement.classList.add('fa-eye-slash');\r\n            moduleElement.dataset.visibility = false;\r\n        } else {\r\n            statusElement.classList.remove('fa-eye-slash');\r\n            statusElement.classList.add('fa-eye');\r\n            moduleElement.dataset.visibility = true;\r\n        }\r\n\r\n        var promise = Fragment.loadFragment('mod_contentdesigner', 'update_visibility', Data.contextid, params).then(() => {\r\n            return true;\r\n        });\r\n        LoadingIcon.addIconToContainerRemoveOnCompletion(loaderItem, promise);\r\n    };\r\n\r\n\r\n    /**\r\n     * Performs an action on a element (moving, deleting, duplicating, hiding, etc.)\r\n     *\r\n     * @param {JQuery} moduleElement activity element we perform action on\r\n     * @param {Number} elementId\r\n     * @param {Number} instanceId\r\n     * @param {String} action Action of the current clicked element.\r\n     */\r\n    var editElement = function(moduleElement, elementId, instanceId, action) {\r\n        var args = {\r\n            cmid: cmID,\r\n            action: action,\r\n            elementid: elementId,\r\n            instanceid: instanceId,\r\n        };\r\n        Fragment.loadFragment('mod_contentdesigner', 'edit_element', contextID, args).then((html) => {\r\n            moduleElement.parentNode.replaceWith(html);\r\n            return;\r\n        }).fail(Notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Displays the delete confirmation to delete a module\r\n     *\r\n     * @param {String} element\r\n     * @param {Function} onconfirm function to execute on confirm\r\n     */\r\n    var confirmDeleteElement = function(element, onconfirm) {\r\n        var elementTypename = 'element_'.element;\r\n        Str.get_string('pluginname', elementTypename).done(function() {\r\n            var plugindata = {\r\n                element: element\r\n            };\r\n            Str.get_strings([\r\n                {key: 'confirm', component: 'core'},\r\n                {key: 'deletechecktype', component: 'mod_contentdesigner', param: plugindata},\r\n                {key: 'yes'},\r\n                {key: 'no'}\r\n            ]).done(function(s) {\r\n                    Notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\r\n                }\r\n            );\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Load the elements list modal to insert new element\r\n     *\r\n     * @param {String} position where the element need to insert.\r\n     * @param {Boolean} chapter chapter id to insert element.\r\n     * @returns {Object}\r\n     */\r\n    const buildAddElementModal = (position = \"bottom\", chapter = 0) => {\r\n        var params = {cmid: Data.cm.id};\r\n        return Modal.create({\r\n            type: Modal.TYPE,\r\n            title: Str.get_string('addelement', 'contentdesigner'),\r\n            body: Fragment.loadFragment('mod_contentdesigner', 'get_elements_list', contextID, params),\r\n            large: false,\r\n        }).then(modal => {\r\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\r\n                modal.getRoot().get(0).querySelectorAll('.element-item').forEach((e) => {\r\n                    e.addEventListener('click', function(e) {\r\n                        if (e.target.closest('.element-item')) {\r\n                            var element = e.currentTarget.dataset.element;\r\n                            var params = {\r\n                                cmid: Data.cm.id,\r\n                                element: element,\r\n                                chapter: chapter,\r\n                                position: position,\r\n                                sesskey: M.cfg.sesskey\r\n                            };\r\n                            const urlParams = new URLSearchParams(params);\r\n                            window.location = M.cfg.wwwroot + '/mod/contentdesigner/element.php?' + urlParams.toString();\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n            modal.show();\r\n            return modal;\r\n        });\r\n    };\r\n\r\n    return {\r\n        init: function(contextid, cmid) {\r\n            return editor(contextid, cmid);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Modal","ModalEvents","Str","Fragment","Templates","Notification","LoadingIcon","Data","contentDesigner","contextID","cmID","loaderItem","initEventListeners","document","body","addEventListener","e","addElement","target","closest","elementAction","moduleElement","undefined","action","getAttribute","elementId","element","instanceId","confirmDeleteElement","editElement","moveElement","updateStatus","preventDefault","position","dataset","chapter","buildAddElementModal","promise","elementshortname","item","parentNode","insertBefore","previousElementSibling","nextElementSibling","contents","querySelectorAll","forEach","push","id","params","chapters","join","cmid","cm","loadFragment","contextid","done","html","js","replaceNode","fail","exception","addIconToContainerRemoveOnCompletion","previousChapter","append","querySelector","childNodes","updateChapterElements","nextChapter","prepend","contentid","chapterid","statusElement","instance","instanceid","status","visibility","classList","remove","add","then","args","elementid","replaceWith","onconfirm","elementTypename","get_string","plugindata","get_strings","key","component","param","s","confirm","create","type","TYPE","title","large","modal","getRoot","on","bodyRendered","get","currentTarget","sesskey","M","cfg","urlParams","URLSearchParams","window","location","wwwroot","toString","show","init","editor"],"mappings":"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"}